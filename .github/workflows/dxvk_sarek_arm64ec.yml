name: build-dxvk-sarek-arm64ec

on:
  workflow_dispatch:

env:
  # Upstream SAREK repo & fixed ARM64EC toolchain
  UPSTREAM_REPO: pythonlover02/DXVK-Sarek
  TOOLCHAIN_URL: https://github.com/bylaws/llvm-mingw/releases/download/20250305/llvm-mingw-20250305-ucrt-ubuntu-20.04-x86_64.tar.xz

jobs:
  build:
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout this repo (workflow)
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            ninja-build meson python3 \
            glslang-tools ca-certificates curl xz-utils \
            pkgconf jq git

      - name: Resolve latest release tag on 'main' (upstream)
        id: rel
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          api="https://api.github.com/repos/${{ env.UPSTREAM_REPO }}"
          # Prefer the most recent published release that targets 'main'
          tag=$(curl -fsSL -H "Authorization: Bearer ${GH_TOKEN}" -H "X-GitHub-Api-Version: 2022-11-28" "$api/releases" \
            | jq -r '[.[] | select(.draft==false and .prerelease==false and .target_commitish=="main")] 
                      | (max_by(.created_at//.published_at) | .tag_name) // ""')
          if [ -z "$tag" ]; then
            # Fallback to 'latest'
            tag=$(curl -fsSL -H "Authorization: Bearer ${GH_TOKEN}" -H "X-GitHub-Api-Version: 2022-11-28" "$api/releases/latest" \
              | jq -r '.tag_name // ""')
          fi
          [ -n "$tag" ] || { echo "::error::Failed to resolve a release tag for ${{ env.UPSTREAM_REPO }}"; exit 1; }
          echo "Resolved tag: $tag"
          echo "tag=$tag" >> "$GITHUB_OUTPUT"

      - name: Checkout upstream DXVK-Sarek (release tag)
        uses: actions/checkout@v4
        with:
          repository: ${{ env.UPSTREAM_REPO }}
          ref: ${{ steps.rel.outputs.tag }}
          submodules: recursive
          fetch-depth: 0
          path: dxvk

      - name: Download ARM64EC llvm-mingw toolchain (bylaws)
        run: |
          set -euo pipefail
          mkdir -p "$HOME/toolchain"
          curl -L "${{ env.TOOLCHAIN_URL }}" -o /tmp/llvm-mingw.tar.xz
          tar -xJf /tmp/llvm-mingw.tar.xz -C "$HOME/toolchain" --strip-components=1
          echo "$HOME/toolchain/bin" >> "$GITHUB_PATH"

      - name: Show toolchain info + dump macros (baseline)
        run: |
          set -euo pipefail
          which arm64ec-w64-mingw32-g++
          arm64ec-w64-mingw32-g++ --version
          echo '== Predefined macros (baseline) =='
          arm64ec-w64-mingw32-g++ -dM -E - < /dev/null | \
            egrep -E '__arm64ec__|_M_ARM64EC|__aarch64__|__x86_64__|_M_X64|_M_AMD64' || true
          echo '== Include search paths =='
          arm64ec-w64-mingw32-g++ -v -E -x c++ /dev/null || true

      - name: Generate Meson cross file for ARM64EC
        working-directory: dxvk
        run: |
          set -euo pipefail
          cat > arm64ec.meson <<'EOF'
          [binaries]
          ar = 'arm64ec-w64-mingw32-ar'
          c = 'arm64ec-w64-mingw32-gcc'
          cpp = 'arm64ec-w64-mingw32-g++'
          ld = 'arm64ec-w64-mingw32-ld'
          windres = 'arm64ec-w64-mingw32-windres'
          widl = 'arm64ec-w64-mingw32-widl'
          strip = 'llvm-strip'

          [host_machine]
          system = 'windows'
          cpu_family = 'aarch64'
          cpu = 'aarch64'
          endian = 'little'

          [built-in options]
          c_args  = ['-DSAREK_ARM64EC=1','-D__CRT__NO_INLINE=1','-D__SSE__=0','-D__SSE2__=0','-D__SSE3__=0','-D__SSSE3__=0','-D__SSE4_1__=0','-D__SSE4_2__=0','-D__AVX__=0','-D__AVX2__=0']
          cpp_args= ['-DSAREK_ARM64EC=1','-D__CRT__NO_INLINE=1','-D__SSE__=0','-D__SSE2__=0','-D__SSE3__=0','-D__SSSE3__=0','-D__SSE4_1__=0','-D__SSE4_2__=0','-D__AVX__=0','-D__AVX2__=0']
          EOF
          echo "== arm64ec.meson ==" && nl -ba arm64ec.meson

      # --- SAREK-SPECIFIC PATCH START ---
      # SAREK 전용: ARM64EC에서 x86 인트린식/SSE 경로가 활성화되는 문제를 빌드 직전에 차단
      - name: Patch SAREK headers to avoid x86 intrinsics on ARM64EC
        working-directory: dxvk
        run: |
          set -euo pipefail

          ARM64EC_PROLOG='#if defined(SAREK_ARM64EC) || defined(__arm64ec__) || defined(_M_ARM64EC)
            /* SAREK on ARM64EC: disable x86/SSE/AVX paths */
            #undef __x86_64__
            #undef _M_X64
            #undef _M_AMD64
            #undef __i386__
            #undef _M_IX86
            #undef __SSE__
            #undef __SSE2__
            #undef __SSE3__
            #undef __SSSE3__
            #undef __SSE4_1__
            #undef __SSE4_2__
            #undef __AVX__
            #undef __AVX2__
          #endif
          '

          for f in src/util/util_vector.h src/util/util_bit.h; do
            if [ -f "$f" ] && ! grep -q 'SAREK on ARM64EC: disable x86/SSE/AVX' "$f"; then
              echo "Injecting ARM64EC prolog into: $f"
              tmp=$(mktemp)
              printf "%s\n" "$ARM64EC_PROLOG" > "$tmp"
              cat "$f" >> "$tmp"
              mv "$tmp" "$f"
            fi
          done

          # DXVK 소스/헤더만 대상으로 하고, 서드파티(include/vulkan, include/spirv)는 제외
          find src include -type f \( -name '*.h' -o -name '*.hpp' -o -name '*.c' -o -name '*.cpp' -o -name '*.inl' \) \
            -not -path 'include/vulkan/*' -not -path 'include/spirv/*' > __filelist.txt

          # 1) x86 인트린식 include 가드 치환
          mapfile -t HDR_FILES < <(grep -RIl -E '#\s*include\s*<(x86intrin|x86gprintrin|immintrin|intrin)\.h>' --file=__filelist.txt 2>/dev/null || true)
          for f in "${HDR_FILES[@]}"; do
            echo "Patching includes in: $f"
            sed -i -E \
              's@(#\s*include\s*<)(x86intrin|x86gprintrin|immintrin|intrin)\.h>@#if !defined(SAREK_ARM64EC) \&\& !defined(__arm64ec__) \&\& !defined(_M_ARM64EC)\n\1\2.h>\n#endif@g' \
              "$f"
          done

          # 2) x86 감지 조건 치환
          mapfile -t COND_FILES < <(grep -RIl -E 'defined\((__x86_64__|_M_X64|_M_AMD64|__i386__|_M_IX86)\)' --file=__filelist.txt 2>/dev/null || true)
          for f in "${COND_FILES[@]}"; do
            echo "Patching arch guards in: $f"
            sed -i -E \
              's@defined\((__x86_64__|_M_X64|_M_AMD64|__i386__|_M_IX86)\)@defined(\1) \&\& !defined(SAREK_ARM64EC) \&\& !defined(__arm64ec__) \&\& !defined(_M_ARM64EC)@g' \
              "$f"
          done

          # 검증(컴파일러 관점): ARM64EC 조건에서 실제로 x86 인트린식이 포함되는지 확인
          cat > __inc_test.cpp <<'INC'
          #include "src/util/util_bit.h"
          #include "src/util/util_vector.h"
          INC

          CXX=arm64ec-w64-mingw32-g++
          CXXFLAGS="-E -x c++ -std=c++17 -DSAREK_ARM64EC=1 -D__CRT__NO_INLINE=1 -D_FILE_OFFSET_BITS=64 -D_WIN32_WINNT=0x0A00 -DDXVK_WSI_WIN32 -I. -Isrc -Iinclude"

          if $CXX $CXXFLAGS -H __inc_test.cpp -o /dev/null 2> __inc_tree.log; then
            echo "== Include tree (tail) ==" && tail -n 120 __inc_tree.log || true
            if egrep -q '/(x86intrin|immintrin|intrin)\.h' __inc_tree.log; then
              echo "::error::Compiler still includes x86 intrinsics headers under ARM64EC"; exit 1
            fi
          else
            echo "note: -H failed or preprocessing failed, trying dependency scan fallback..."
            $CXX -MMD -MF __inc_deps.d -MP -MT dummy $CXXFLAGS __inc_test.cpp -o /dev/null 2> __inc_dep_err.log || true
            cat __inc_dep_err.log || true
            if [ -f __inc_deps.d ] && egrep -q '(x86intrin|immintrin|intrin)\.h' __inc_deps.d; then
              echo "::error::Deps show x86 intrinsics headers"; cat __inc_deps.d; exit 1
            fi
          fi

          echo "== Head of src/util/util_bit.h (after patch) =="
          head -n 40 src/util/util_bit.h || true
      # --- SAREK-SPECIFIC PATCH END ---

      - name: Wipe build dir (idempotent & -e safe)
        working-directory: dxvk
        shell: bash
        run: |
          if [ -d build.w64 ]; then
            rm -rf build.w64
            echo "Removed build.w64"
          else
            echo "No build.w64 (ok)"
          fi
          if [ -d install ]; then
            rm -rf install
            echo "Removed install"
          else
            echo "No install (ok)"
          fi

      - name: "Preflight: meson.build presence"
        working-directory: dxvk
        run: |
          set -euo pipefail
          test -f meson.build || { echo "::error::meson.build not found in $PWD"; ls -la; exit 1; }

      - name: Configure (Meson)
        working-directory: dxvk
        run: |
          set -euo pipefail
          meson setup build.w64 . --cross-file arm64ec.meson --buildtype release --prefix "$PWD/install"
          meson configure build.w64
          echo '== Meson build options (excerpt) =='
          meson introspect build.w64 --buildoptions | head -n 120 || true

      - name: Macro snapshot after configure (with injected defines)
        working-directory: dxvk
        run: |
          set -euo pipefail
          echo '== Predefined macros (+ our -D) =='
          arm64ec-w64-mingw32-g++ -dM -E -DSAREK_ARM64EC=1 -D__CRT__NO_INLINE=1 - < /dev/null | \
            egrep -E 'SAREK_ARM64EC|__CRT__NO_INLINE|__arm64ec__|_M_ARM64EC|__aarch64__|__x86_64__|_M_X64|_M_AMD64' || true

      - name: Build
        working-directory: dxvk
        run: |
          set -euo pipefail
          meson compile -C build.w64 -v

      - name: Install into staging dir
        working-directory: dxvk
        run: |
          set -euo pipefail
          meson install -C build.w64

      - name: Upload DLL artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dxvk-sarek-arm64ec-dlls
          path: |
            dxvk/install/bin/*.dll
            dxvk/install/bin/*.pdb
          if-no-files-found: error

      - name: Upload build logs (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dxvk-sarek-arm64ec-logs
          path: |
            dxvk/build.w64/meson-logs/**
            dxvk/build.w64/meson-info/**
            dxvk/meson-logs/**
            dxvk/arm64ec.meson
            dxvk/__inc_tree.log
            dxvk/__inc_dep_err.log
            dxvk/__inc_deps.d
          if-no-files-found: warn
