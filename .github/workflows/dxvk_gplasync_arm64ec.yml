name: Build DXVK gplasync-arm64ec v2

on:
  workflow_dispatch:              # Manual trigger (any branch)
  schedule:
    - cron: "0 18 * * *"         # Daily (UTC)

permissions:
  contents: write

# Strict, fast shell; no caches anywhere
defaults:
  run:
    shell: 'bash --noprofile --norc -Eeuo pipefail {0}'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  guard:
    name: Fast guard (detect new DXVK tag + GPLAsync rev)
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      build: ${{ steps.decide.outputs.build }}
    steps:
      - name: Install jq, curl (minimal)
        run: |
          sudo apt-get -yq update
          sudo apt-get -yq install --no-install-recommends jq curl ca-certificates

      - name: Collect already-published (base,rev)             # Avoid re-building uploaded variants
        id: have
        env:
          GH_TOKEN: ${{ github.token }}
          REPO:     ${{ github.repository }}
          RELEASE_TAG: DXVK-GPLASYNC-ARM64EC
        run: |
          API="https://api.github.com"
          auth=(-H "Authorization: Bearer ${GH_TOKEN}")
          ver=(-H "Accept: application/vnd.github+json")
          HTTP="$(curl -s -o /tmp/rel.json -w '%{http_code}' "${auth[@]}" "${ver[@]}" \
                  "$API/repos/${REPO}/releases/tags/${RELEASE_TAG}" || true)"
          if [ "$HTTP" = "200" ]; then
            jq -r '.assets[].name' /tmp/rel.json \
              | sed -n -E 's/^dxvk-gplasync-arm64ec-([0-9]+\.[0-9]+(\.[0-9]+)?)-([0-9]+)\.wcp$/\1 \3/p' \
              | sort -V > /tmp/exist.txt
          else
            : > /tmp/exist.txt
          fi
          echo "Existing base/rev:"; cat /tmp/exist.txt || true

      - name: Detect any missing candidate (API-only)
        id: detect
        env:
          GH_TOKEN: ${{ github.token }}
          GPLASYNC_BASE_URL: https://gitlab.com/Ph42oN/dxvk-gplasync/-/raw/main/patches
          DXVK_REPO: doitsujin/dxvk
        run: |
          API="https://api.github.com"
          auth=(-H "Authorization: Bearer ${GH_TOKEN}")
          ver=(-H "Accept: application/vnd.github+json")

          # Fetch tags, keep semver v* >= 2.3.1
          curl -fsSL "${auth[@]}" "${ver[@]}" "$API/repos/${DXVK_REPO}/tags?per_page=100" \
            | jq -r '.[].name' \
            | grep -E '^v[0-9]+\.[0-9]+(\.[0-9]+)?$' \
            | sort -V > /tmp/tags.txt

          awk '
            function cmp(a,b,  i,A,B){split(a,A,".");split(b,B,".");
              for(i=1;i<=3;i++){if((A[i]+0)<(B[i]+0))return -1;if((A[i]+0)>(B[i]+0))return 1} return 0}
            { base=substr($0,2); if (cmp(base,"2.3.1")>=0) print $0 }
          ' /tmp/tags.txt > /tmp/candidates.txt

          echo "Candidate tags (>= v2.3.1):"; cat /tmp/candidates.txt || true
          echo -n "no" > /tmp/missing.flag

          GPL="${GPLASYNC_BASE_URL}"
          while read -r tag; do
            [ -n "$tag" ] || continue
            base="${tag#v}"
            mm="${base%.*}"

            found_rev=""
            # Try exact base first
            for n in 9 8 7 6 5 4 3 2 1; do
              url="${GPL}/dxvk-gplasync-${base}-${n}.patch"
              if curl -fsI "$url" >/dev/null 2>&1; then found_rev="$n"; break; fi
            done
            # Fallback to major.minor if base has 3 parts
            if [ -z "$found_rev" ] && [ "$mm" != "$base" ]; then
              for n in 9 8 7 6 5 4 3 2 1; do
                url="${GPL}/dxvk-gplasync-${mm}-${n}.patch"
                if curl -fsI "$url" >/dev/null 2>&1; then found_rev="$n"; break; fi
              done
            fi

            if [ -n "$found_rev" ] && ! grep -Fq "${base} ${found_rev}" /tmp/exist.txt; then
              echo "MISSING: ${base}-${found_rev}"
              echo -n "yes" > /tmp/missing.flag
              break
            fi
          done < /tmp/candidates.txt

          [ "$(cat /tmp/missing.flag)" = "yes" ] && echo "missing=true"  >> "$GITHUB_OUTPUT" || echo "missing=false" >> "$GITHUB_OUTPUT"

      - name: Decide build
        id: decide
        run: |
          if [ "${{ steps.detect.outputs.missing }}" = "true" ]; then
            echo "build=true"  >> "$GITHUB_OUTPUT"
          else
            echo "build=false" >> "$GITHUB_OUTPUT"
          fi

  build-and-release:
    name: Build & release gplasync-arm64ec
    needs: guard
    if: needs.guard.outputs.build == 'true'
    runs-on: ubuntu-24.04
    env:
      DXVK_REPO: doitsujin/dxvk
      GPLASYNC_BASE_URL: https://gitlab.com/Ph42oN/dxvk-gplasync/-/raw/main/patches
      PREFIX_EC: ${{ github.workspace }}/dist-arm64ec
      PREFIX_X86: ${{ github.workspace }}/dist-x86
      TOOLCHAIN_DIR: /opt/llvm-mingw
      RELEASE_TAG: DXVK-GPLASYNC-ARM64EC
      GH_TOKEN: ${{ github.token }}

    steps:
      # ───────────────────────── Tooling (no caches) ────────────────────────
      - name: Install host tooling (lean set; no cache)
        run: |
          sudo apt-get -yq update
          sudo apt-get -yq install --no-install-recommends \
            curl xz-utils jq ca-certificates \
            git meson ninja-build glslang-tools pkg-config \
            build-essential python3 zstd gh

      - name: Ensure glslang (--vn) is available               # DXVK shader includes require --vn
        run: |
          cat > /tmp/min.comp <<'GLSL'
          #version 450
          void main() {}
          GLSL
          try() { command -v "$1" >/dev/null 2>&1 || return 1; "$1" --quiet --target-env vulkan1.3 --vn testvar -o /tmp/min.h /tmp/min.comp; }
          if try glslang; then :
          elif try glslangValidator; then
            BIN="$HOME/.local/bin"; mkdir -p "$BIN"
            ln -sf "$(command -v glslangValidator)" "$BIN/glslang"
            echo "$BIN" >> "$GITHUB_PATH"
          else
            echo "::error::No glslang/glslangValidator with working --vn"; exit 1
          fi

      # ─────────────────────────── llvm-mingw (fallback set) ──────────────────
      - name: Download llvm-mingw (ucrt, ubuntu x86_64)        # Provides clang-based triplets
        run: |
          json=$(curl -fsSL -H "Authorization: Bearer $GH_TOKEN" https://api.github.com/repos/mstorsjo/llvm-mingw/releases/latest)
          url=$(echo "$json" | jq -r '.assets[] | select(.name|test("ucrt-ubuntu-.*-x86_64\\.tar\\.xz$")) .browser_download_url' | head -n1)
          [[ -n "$url" ]] || { echo "::error::llvm-mingw asset not found"; exit 1; }
          sudo mkdir -p "$TOOLCHAIN_DIR"
          curl -fL -H "Authorization: Bearer $GH_TOKEN" "$url" -o /tmp/llvm-mingw.tar.xz
          sudo tar -C "$TOOLCHAIN_DIR" --strip-components=1 -xJf /tmp/llvm-mingw.tar.xz
          echo "$TOOLCHAIN_DIR/bin" >> "$GITHUB_PATH"
          export PATH="$TOOLCHAIN_DIR/bin:$PATH"   # ensure toolchain comes first

      # ───────────────────────────── Cross files ──────────────────────────────
      - name: Create Meson cross files (GCC-first; safe fallbacks)
        run: |
          set -Eeuo pipefail

          pick() { command -v "$1" >/dev/null 2>&1 && echo "$1" || echo "$2"; }

          # --- arm64ec (prefer GCC; fallback to clang/llvm) ---
          A_AR=$(pick arm64ec-w64-mingw32-ar arm64ec-w64-mingw32-ar)
          A_CC=$(pick arm64ec-w64-mingw32-gcc arm64ec-w64-mingw32-clang)
          A_CXX=$(pick arm64ec-w64-mingw32-g++ arm64ec-w64-mingw32-clang++)
          A_RC=$(pick arm64ec-w64-mingw32-windres llvm-rc)
          A_STRIP=$(pick llvm-strip arm64ec-w64-mingw32-strip)
          A_WIDL=$(pick arm64ec-w64-mingw32-widl widl)
          A_PKG=$(pick aarch64-linux-gnu-pkg-config pkg-config)

          # --- i686 (prefer GCC; fallback to clang/llvm) ---
          I_AR=$(pick i686-w64-mingw32-ar i686-w64-mingw32-ar)
          I_CC=$(pick i686-w64-mingw32-gcc i686-w64-mingw32-clang)
          I_CXX=$(pick i686-w64-mingw32-g++ i686-w64-mingw32-clang++)
          I_RC=$(pick i686-w64-mingw32-windres llvm-rc)
          I_STRIP=$(pick llvm-strip i686-w64-mingw32-strip)
          I_PKG=$(pick i686-w64-mingw32-pkg-config pkg-config)

          cat > "${{ github.workspace }}/arm64ec.cross" <<EOF
          [binaries]
          ar = '${A_AR}'
          c = '${A_CC}'
          cpp = '${A_CXX}'
          windres = '${A_RC}'
          strip = '${A_STRIP}'
          widl = '${A_WIDL}'
          pkgconfig = '${A_PKG}'
          [host_machine]
          system = 'windows'
          cpu_family = 'aarch64'
          cpu = 'aarch64'
          endian = 'little'
          EOF

          cat > "${{ github.workspace }}/i686.cross" <<EOF
          [binaries]
          ar = '${I_AR}'
          c = '${I_CC}'
          cpp = '${I_CXX}'
          windres = '${I_RC}'
          strip = '${I_STRIP}'
          pkgconfig = '${I_PKG}'
          [host_machine]
          system = 'windows'
          cpu_family = 'x86'
          cpu = 'i686'
          endian = 'little'
          EOF

      # ───────────────────────── Source & candidates ──────────────────────────
      - name: Clone DXVK (tags + submodules)
        run: |
          git clone --recurse-submodules https://github.com/${DXVK_REPO}.git src
          cd src && git fetch --tags --force

      - name: Resolve versions (>= v2.3.1) & compute NEW (base,rev,patch_base)
        env:
          REPO: ${{ github.repository }}
          GH_TOKEN: ${{ github.token }}
          GPLASYNC_BASE_URL: https://gitlab.com/Ph42oN/dxvk-gplasync/-/raw/main/patches
          RELEASE_TAG: DXVK-GPLASYNC-ARM64EC
        run: |
          cd src
          git tag -l 'v*' \
            | { grep -E '^v[0-9]+\.[0-9]+(\.[0-9]+)?$' || true; } \
            | sort -V \
            | awk '
                function cmp(a,b,  i,A,B){split(a,A,".");split(b,B,".");
                  for(i=1;i<=3;i++){if((A[i]+0)<(B[i]+0))return -1;if((A[i]+0)>(B[i]+0))return 1}return 0}
                {ver=substr($0,2); if (cmp(ver,"2.3.1")>=0) print $0}
              ' > "${GITHUB_WORKSPACE}/versions.txt"

          echo "Candidates:"; cat "${GITHUB_WORKSPACE}/versions.txt" || true

          EXIST="/tmp/exist.txt"; : > "$EXIST"
          if gh release view "${RELEASE_TAG}" --repo "${REPO}" >/dev/null 2>&1; then
            gh api repos/"${REPO}"/releases/tags/"${RELEASE_TAG}" \
              | jq -r '.assets[].name' \
              | sed -n -E 's/^dxvk-gplasync-arm64ec-([0-9]+\.[0-9]+(\.[0-9]+)?)-([0-9]+)\.wcp$/\1 \3/p' \
              | sort -V > "$EXIST" || true
          fi
          echo "Already published (base rev):"; cat "$EXIST" || true

          : > "${GITHUB_WORKSPACE}/to_build.txt"
          GPL="${GPLASYNC_BASE_URL}"
          while IFS= read -r tag; do
            base="${tag#v}"
            mm="${base%.*}"
            found_rev=""; patch_base=""

            # exact base
            for n in 9 8 7 6 5 4 3 2 1; do
              url="${GPL}/dxvk-gplasync-${base}-${n}.patch"
              if curl -fsI "$url" >/dev/null 2>&1; then found_rev="$n"; patch_base="$base"; break; fi
            done
            # fallback x.y
            if [[ -z "$found_rev" && "$mm" != "$base" ]]; then
              for n in 9 8 7 6 5 4 3 2 1; do
                url="${GPL}/dxvk-gplasync-${mm}-${n}.patch"
                if curl -fsI "$url" >/dev/null 2>&1; then found_rev="$n"; patch_base="$mm"; break; fi
              done
            fi

            if [[ -z "$found_rev" ]]; then
              echo "::notice::No gplasync patch for ${base} (or ${mm}); skipping"
              continue
            fi
            if grep -Fq "${base} ${found_rev}" "$EXIST"; then
              echo "Skip ${base}-${found_rev} (already built)"; continue
            fi
            echo "${tag} ${base} ${found_rev} ${patch_base}" >> "${GITHUB_WORKSPACE}/to_build.txt"
          done < "${GITHUB_WORKSPACE}/versions.txt"

          echo "To build (tag base rev patch_base):"
          cat "${GITHUB_WORKSPACE}/to_build.txt" || true

      # ───────────────────────── Build loop (strip-safe) ──────────────────────
      - name: Build NEW versions only (gplasync-arm64ec → WCP)
        env:
          GITHUB_WORKSPACE: ${{ github.workspace }}
          GPLASYNC_BASE_URL: https://gitlab.com/Ph42oN/dxvk-gplasync/-/raw/main/patches
        run: |
          OUT="${GITHUB_WORKSPACE}/out"; mkdir -p "$OUT"
          cd "${GITHUB_WORKSPACE}/src"

          if [[ ! -s "${GITHUB_WORKSPACE}/to_build.txt" ]]; then
            echo "No new versions to build."; exit 0
          fi

          while read -r tag base rev patch_base; do
            echo "::group::Build ${tag} (gplasync rev ${rev}, patch_base ${patch_base})"
            git checkout -f "$tag"
            git submodule update --init --recursive --checkout

            # Apply GPLASYNC patch (try am; fallback to apply --reject)
            url="${GPLASYNC_BASE_URL}/dxvk-gplasync-${patch_base}-${rev}.patch"
            curl -fL "$url" -o /tmp/gpl.patch
            git config user.name  ci
            git config user.email ci@local
            if git am -3 /tmp/gpl.patch; then :; else git am --abort || true; git apply -p1 --reject /tmp/gpl.patch; fi
            grep -q "enableAsync" src/dxvk/dxvk_options.h || { echo "::error::Patch not applied cleanly for ${base} (using ${patch_base}-${rev})"; git status -sb; exit 1; }

            # --- Apply minimal compat patches (D3D9/11 headers) ---
            # Remove duplicated legacy devinfo typedefs that may conflict with Windows SDK
            hdr="src/d3d9/d3d9_include.h"
            if [[ -f "$hdr" ]]; then
              for sym in _D3DDEVINFO_RESOURCEMANAGER _D3DDEVINFO_D3D9PIPELINETIMINGS _D3DDEVINFO_VCACHE _D3DDEVINFO_PRIVATEDATA _D3DDEVINFO_VERTEXSTATS; do
                if grep -q "typedef struct ${sym}" "$hdr"; then
                  awk -v pat="typedef struct ${sym}" 'BEGIN{drop=0}
                    index($0, pat){drop=1; next}
                    drop==1 && /\}[[:space:]]*[^;]*;[[:space:]]*$/ {drop=0; next}
                    drop==0 {print}' "$hdr" > "$hdr.new" && mv "$hdr.new" "$hdr"
                fi
              done
            fi
            # Make UnmappedSubresource constant portable across mingw/LLVM modes
            hdr2="src/d3d11/d3d11_texture.h"
            if [[ -f "$hdr2" ]] && grep -qE 'constexpr[[:space:]]+D3D11_MAP[[:space:]]+UnmappedSubresource' "$hdr2"; then
              sed -i -E 's/static[[:space:]]+constexpr[[:space:]]+D3D11_MAP[[:space:]]+UnmappedSubresource[[:space:]]*=[[:space:]]*D3D11_MAP\(-1u\);/inline static const D3D11_MAP UnmappedSubresource = (D3D11_MAP)0xFFFFFFFFu;/' "$hdr2" || true
            fi
            # ------------------------------------------------------

            # Optional features if available
            MESON_D3D8=""
            if [[ -f meson_options.txt ]] && grep -qE "option\(['\"]enable_d3d8['\"]" meson_options.txt; then
              MESON_D3D8="-Denable_d3d8=true"
            fi

            # Fresh builds per arch
            rm -rf "${GITHUB_WORKSPACE}/build.ec" "${GITHUB_WORKSPACE}/build.x86" \
                   "${PREFIX_EC}" "${PREFIX_X86}" \
                   "${GITHUB_WORKSPACE}/DXVK_WCP"

            # Configure & build (ARM64EC)
            meson setup "${GITHUB_WORKSPACE}/build.ec" \
              --cross-file "${GITHUB_WORKSPACE}/arm64ec.cross" \
              --buildtype release \
              --prefix "${PREFIX_EC}" \
              -Dbuild_id=false -Dstrip=true \
              ${MESON_D3D8}
            ninja -C "${GITHUB_WORKSPACE}/build.ec" -j"$(nproc)"
            meson install --no-rebuild -C "${GITHUB_WORKSPACE}/build.ec"

            # Configure & build (i686)
            meson setup "${GITHUB_WORKSPACE}/build.x86" \
              --cross-file "${GITHUB_WORKSPACE}/i686.cross" \
              --buildtype release \
              --prefix "${PREFIX_X86}" \
              -Dbuild_id=false -Dstrip=true \
              ${MESON_D3D8}
            ninja -C "${GITHUB_WORKSPACE}/build.x86" -j"$(nproc)"
            meson install --no-rebuild -C "${GITHUB_WORKSPACE}/build.x86"

            # Collect DLLs (system32 = ARM64EC, syswow64 = i686)
            mkdir -p "${GITHUB_WORKSPACE}/DXVK_WCP/system32" "${GITHUB_WORKSPACE}/DXVK_WCP/syswow64"
            cp -v "${PREFIX_EC}/bin/"*.dll  "${GITHUB_WORKSPACE}/DXVK_WCP/system32/" || true
            cp -v "${PREFIX_X86}/bin/"*.dll "${GITHUB_WORKSPACE}/DXVK_WCP/syswow64/" || true

            # Build lists for profile.json
            (cd "${GITHUB_WORKSPACE}/DXVK_WCP" && find system32 -maxdepth 1 -type f -name '*.dll' -printf '%f\n' | sort) > /tmp/ec.txt || true
            (cd "${GITHUB_WORKSPACE}/DXVK_WCP" && find syswow64 -maxdepth 1 -type f -name '*.dll' -printf '%f\n' | sort) > /tmp/x86.txt || true
            if [[ ! -s /tmp/ec.txt && ! -s /tmp/x86.txt ]]; then
              echo "::error::No DLLs discovered for ${base}-${rev}"; exit 1; fi

            jq -R -s 'split("\n") | map(select(length>0))' /tmp/ec.txt  > /tmp/ec.json
            jq -R -s 'split("\n") | map(select(length>0))' /tmp/x86.txt > /tmp/x86.json

            # Reproducible timestamp from tag commit
            export SOURCE_DATE_EPOCH="$(git log -1 --format=%ct "$tag")"

            # profile.json (ALWAYS include) — exact app schema
            DESC="DXVK gplasync-arm64ec build by Ari"
            if [[ "${patch_base}" != "${base}" ]]; then
              DESC="${DESC} (patch-from ${patch_base})"
            fi

            jq -n \
              --arg VN "gplasync-arm64ec-${base}" \
              --argjson VC "${rev}" \
              --arg DESC "$DESC" \
              --arg SYS '${system32}/' \
              --arg WOW '${syswow64}/' \
              --slurpfile ec /tmp/ec.json \
              --slurpfile x86 /tmp/x86.json \
              '
              ($ec[0]  // []) as $E |
              ($x86[0] // []) as $X |
              {
                type: "DXVK",
                versionName: $VN,
                versionCode: $VC,
                description: $DESC,
                files: [
                  ($E[]? | {source: ("system32/"+.), target: ($SYS + .)}),
                  ($X[]? | {source: ("syswow64/"+.), target: ($WOW + .)})
                ]
              }' > "${GITHUB_WORKSPACE}/DXVK_WCP/profile.json"

            # Pack WCP (sorted, owner fixed => reproducible-ish)
            tar -C "${GITHUB_WORKSPACE}/DXVK_WCP" --zstd --format=gnu --owner=0 --group=0 --numeric-owner \
              --sort=name \
              -cf "${OUT}/dxvk-gplasync-arm64ec-${base}-${rev}.wcp" profile.json system32 syswow64
            echo "::endgroup::"
          done < "${GITHUB_WORKSPACE}/to_build.txt"

      # ───────────────────── Release notes (minimal) ──────────────────────────
      - name: Build release notes (minimal)
        run: |
          NOTES="${GITHUB_WORKSPACE}/RELEASE_NOTES.md"
          printf '🤖 Automated gplasync-arm64ec builds (2.3.1+)\n\n' > "$NOTES"
          if compgen -G "${GITHUB_WORKSPACE}/out/dxvk-gplasync-arm64ec-*.wcp" > /dev/null; then
            latest="$(ls -1 "${GITHUB_WORKSPACE}/out"/dxvk-gplasync-arm64ec-*.wcp | sed 's#.*/##' | LC_ALL=C sort -V | tail -n1)"
            cur="${latest#dxvk-gplasync-arm64ec-}"; cur="${cur%.wcp}"
            echo "Current: ${cur}" >> "$NOTES"
          fi
          cat "$NOTES"

      # ─────────────────────── Upload & Release (append) ──────────────────────
      - name: Create/Update GitHub Release (DXVK-GPLASYNC-ARM64EC) + upload WCPs
        env:
          REPO: ${{ github.repository }}
          GH_TOKEN: ${{ github.token }}
          RELEASE_TAG: DXVK-GPLASYNC-ARM64EC
        run: |
          NOTES="${GITHUB_WORKSPACE}/RELEASE_NOTES.md"
          if ! gh release view "${RELEASE_TAG}" --repo "${REPO}" >/dev/null 2>&1; then
            gh release create "${RELEASE_TAG}" --repo "${REPO}" -t "${RELEASE_TAG}" -F "$NOTES"
          else
            gh release edit   "${RELEASE_TAG}" --repo "${REPO}" -t "${RELEASE_TAG}" -F "$NOTES"
          fi
          if compgen -G "${GITHUB_WORKSPACE}/out/*.wcp" > /dev/null; then
            gh release upload "${RELEASE_TAG}" "${GITHUB_WORKSPACE}/out/"*.wcp --repo "${REPO}" --clobber
          else
            echo "No new WCP files to upload."
          fi
